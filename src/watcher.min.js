'use strict';require('colors');var _remoteFileWatcher=require('remote-file-watcher');var _remoteFileWatcher2=_interopRequireDefault(_remoteFileWatcher);var _ssh2SftpClient=require('ssh2-sftp-client');var _ssh2SftpClient2=_interopRequireDefault(_ssh2SftpClient);var _path=require('path');var _path2=_interopRequireDefault(_path);var _readFile=require('./utils/readFile');var _readFile2=_interopRequireDefault(_readFile);var _writeFile=require('./utils/writeFile');var _writeFile2=_interopRequireDefault(_writeFile);var _writeError=require('./utils/writeError');var _writeError2=_interopRequireDefault(_writeError);var _writeLog=require('./utils/writeLog');var _writeLog2=_interopRequireDefault(_writeLog);var _parseXMLToJSON=require('./utils/parseXMLToJSON');var _parseXMLToJSON2=_interopRequireDefault(_parseXMLToJSON);var _performRequest=require('./utils/performRequest');var _performRequest2=_interopRequireDefault(_performRequest);var _generateError=require('./utils/generateError');var _generateError2=_interopRequireDefault(_generateError);var _generateDump=require('./utils/generateDump');var _generateDump2=_interopRequireDefault(_generateDump);var _methods=require('./utils/methods');var _logs=require('./logs.json');var _logs2=_interopRequireDefault(_logs);var _settings=require('../settings.js');var _settings2=_interopRequireDefault(_settings);var _generateDate=require('./utils/generateDate');var _generateDate2=_interopRequireDefault(_generateDate);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}// helpers & variables:
// dependencies:
var dir=function dir(src){return _path2.default.join(__dirname,src);};var sftp=new _ssh2SftpClient2.default();var watcher=new _remoteFileWatcher2.default('remote-server',_settings2.default.watcher);sftp.connect(_settings2.default.hosts.remote.connection).then(function(){var counter=0;console.log('Listening for changes...'.gray);watcher.on('uploaded',function(_ref){var serverName=_ref.serverName,folder=_ref.folder,fileName=_ref.fileName;var tmpFile=_settings2.default.hosts.local.folders.temp+'/'+fileName;sftp.get(folder+'/'+fileName).then(function(data){return data.on('data',function(chunk){(0,_writeFile2.default)({content:chunk,pathName:tmpFile}).then(function(pathFile){return(0,_readFile2.default)(pathFile);}).then(function(contentFile){return(0,_parseXMLToJSON2.default)(contentFile);}).then(function(json){var factura=json.Factura;factura.id=factura['$'].id;delete factura['$'];(0,_performRequest2.default)({url:_settings2.default.hosts.local.url,data:factura}).then(function(response){var dump=!!response.toString().includes('Sfdump');var validation=!!((0,_methods.isObject)(response)&&JSON.stringify(response).toLowerCase().includes('validation'));var exception=!!response.toString().includes('Exception');if(dump){(0,_generateDump2.default)(response);}else if(validation){(0,_generateError2.default)(response,'json');}else if(exception){(0,_generateError2.default)(response,'html');}else{sftp.put(tmpFile,_settings2.default.hosts.remote.folders.target+'/'+fileName).then(function(ops){return sftp.delete(_settings2.default.hosts.remote.folders.source+'/'+fileName);}).then(function(ops){return!!_settings2.default.logs.message.uploaded&&console.log(('#'+ ++counter+'. '+(0,_generateDate2.default)().toLowerCase()+' -> "'+fileName+'" uploaded!.').gray);}).catch(function(err){return(0,_generateError2.default)(err.message,'txt');});}}).catch(function(err){return(0,_generateError2.default)('Error when sending data to the datastore: "'+err.message+'"','txt');});}).catch(function(err){return(0,_generateError2.default)('Error when parsing the xml file "'+fileName+'": "'+err.message+'"','txt');});});}).catch(function(err){return(0,_generateError2.default)('Error when getting the file "'+fileName+'": "'+err.message+'"','txt');});});}).catch(function(err){return(0,_generateError2.default)('Error when connecting to "'+process.env.SERVER_A_HOST+'": "'+err.message+'"','txt');});// prints messages of: errors, files deleted and files uploading
if(_settings2.default.logs.message.uploading){watcher.on('uploading',function(_ref2){var fileName=_ref2.fileName;return console.log('The file "'+fileName+'" is uploading...');});}if(_settings2.default.logs.message.deleted){watcher.on('deleted',function(_ref3){var fileName=_ref3.fileName;return console.log(('The file "'+fileName+'" has been deleted.').yellow);});}if(_settings2.default.logs.message.error){watcher.on('error',function(serverName,err){return(0,_generateError2.default)('Error when trying to watch the server: "'+err.message+'"','txt');});}// change number of listeners:
if(_settings2.default.listeners.defaults===Infinity||_settings2.default.listeners.defaults===0){require('events').EventEmitter.defaultMaxListeners=Infinity;}if(_settings2.default.listeners.sftp===Infinity||_settings2.default.listeners.sftp===0){sftp.client.setMaxListeners(Infinity);}if(_settings2.default.listeners.sftp===Infinity||_settings2.default.listeners.sftp===0){watcher.setMaxListeners(Infinity);}
